<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SART – jsPsych v6 (3 & 8 No-Go)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jsPsych v6 core & CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>

  <!-- Plugins -->
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-instructions.js"></script>

  <style>
    body {
      background-color: #f0f0f0;
      touch-action: manipulation;
    }
    .sart-digit {
      font-size: 80px;
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 30vh;
    }
    .circle-mask {
      font-size: 120px;
      text-align: center;
      margin-top: 28vh;
      font-weight: bold;
    }
    /* full-screen invisible button for tap */
    .jspsych-btn {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      opacity: 0;
      border: none;
      background: transparent;
    }
  </style>
</head>

<body></body>

<script>
  // ---------- BASIC CONFIG ----------
  var DIGITS = [1,2,3,4,5,6,7,8,9];
  var NOGO   = [3,8];        // No-Go digits

  // For testing: 40 trials (later make 225–450)
  var N_TRIALS_MAIN = 40;

  // PsyToolkit timings
  var DIGIT_TIME  = 250;     // ms digit visible
  var CIRCLE_TIME = 900;     // ms circle visible (response window)

  var timeline = [];

  // ---------- INSTRUCTIONS ----------
  var instructions = {
    type: 'instructions',
    pages: [
      "<p style='font-size:20px;'>You will see digits from 1–9. Each digit appears very briefly.</p>" +
      "<p style='font-size:20px;'>After every digit, a <strong>circle</strong> will appear.</p>" +
      "<p style='font-size:20px;'><strong>TAP the screen during the circle</strong> for all digits<br>" +
      "<strong>EXCEPT when the digit was <span style='color:red;'>3</span> or <span style='color:red;'>8</span>.</strong></p>" +
      "<p style='font-size:20px;'>Digit = 250 ms<br>Circle = 900 ms</p>" +
      "<p style='font-size:20px;'>Try to be fast and accurate.</p>"
    ],
    show_clickable_nav: true,
    button_label_next: 'Start'
  };
  timeline.push(instructions);

  // ---------- TRIAL GENERATOR ----------
  function make_trials(n, block_label) {
    var trials = [];

    for (var i = 0; i < n; i++) {
      var d = jsPsych.randomization.sampleWithoutReplacement(DIGITS, 1)[0];
      var is_nogo = NOGO.indexOf(d) > -1;

      // 1) DIGIT (250 ms)
      var digit_trial = {
        type: 'html-button-response',
        stimulus: "<div class='sart-digit'>" + d + "</div>",
        choices: ['tap'],
        stimulus_duration: DIGIT_TIME,
        trial_duration: DIGIT_TIME,
        response_ends_trial: false,
        data: {
          task: 'sart',
          part: 'digit',
          block: block_label,
          digit: d,
          is_nogo: is_nogo
        }
      };

      // 2) CIRCLE (900 ms) → RESPONSE WINDOW
      var circle_trial = {
        type: 'html-button-response',
        stimulus: "<div class='circle-mask'>&#9711;</div>",   // hollow circle ring
        choices: ['tap'],
        stimulus_duration: CIRCLE_TIME,
        trial_duration: CIRCLE_TIME,
        response_ends_trial: false,
        data: {
          task: 'sart',
          part: 'circle',
          block: block_label,
          digit: d,
          is_nogo: is_nogo
        },
        on_finish: function(data){
          var tapped = (data.response !== null);
          var comm = 0;
          var omis = 0;
          var corr = 0;

          if (data.is_nogo) {
            if (tapped) { comm = 1; }
            else        { corr = 1; }
          } else {
            if (!tapped){ omis = 1; }
            else        { corr = 1; }
          }

          data.commission_error = comm;
          data.omission_error   = omis;
          data.correct_response = corr;
        }
      };

      trials.push(digit_trial);
      trials.push(circle_trial);
    }

    return trials;
  }

  // ---------- PRACTICE (10 digits) + MAIN (40 digits) ----------
  timeline = timeline.concat(make_trials(10, 'practice'));
  timeline = timeline.concat(make_trials(N_TRIALS_MAIN, 'main'));

  // ---------- INIT & RUN ----------
  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
      var circle_data = jsPsych.data.get().filter({task: 'sart', part: 'circle'});
      circle_data.localSave('csv', 'sart_psytoolkit_style_3_8.csv');
      document.body.innerHTML = "<h2 style='padding:20px;'>Task finished. Thank you!</h2>";
    }
  });
</script>
</html>
